<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - TradingView Webhook Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .signal-card { transition: all 0.3s ease; }
        .signal-card:hover { transform: translateY(-2px); }
        .signal-new { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Trading Journal</h1>
                <p class="text-gray-400">TradingView Webhook Integration</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">User</div>
                <input type="text" id="userName" placeholder="Enter your name" 
                       class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-white">
            </div>
        </div>

        <div class="flex space-x-4 mb-8">
            <button onclick="showTab('signals')" id="signalsTab" 
                    class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 transition">
                Live Signals
            </button>
            <button onclick="showTab('leaderboard')" id="leaderboardTab"
                    class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">
                Leaderboard
            </button>
            <button onclick="showTab('trades')" id="tradesTab"
                    class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">
                All Trades
            </button>
        </div>

        <div id="signalsContent" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Live TradingView Signals</h2>
                <button onclick="testWebhook()" 
                        class="px-3 py-1 bg-yellow-600 rounded hover:bg-yellow-700 text-sm">
                    Test Signal
                </button>
            </div>
            <div id="signalsList" class="space-y-4"></div>
        </div>

        <div id="leaderboardContent" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4">Response Time Competition</h2>
            <div id="leaderboardList"></div>
        </div>

        <div id="tradesContent" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4">All Trades</h2>
            <div id="tradesList"></div>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Create Trade Entry</h3>
            <form id="entryForm" class="space-y-4">
                <input type="hidden" id="entrySignalId">
                <div>
                    <label class="block text-sm font-medium mb-2">Currency Pair</label>
                    <input type="text" id="entryPair" readonly 
                           class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-gray-300">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Direction</label>
                    <select id="entryDirection" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        <option value="long">Long (Buy)</option>
                        <option value="short">Short (Sell)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Entry Price</label>
                    <input type="number" step="0.00001" id="entryEntryPrice" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Reasoning</label>
                    <textarea id="entryReasoning" rows="3" 
                              class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2"></textarea>
                </div>
                <div class="flex space-x-2">
                    <button type="button" onclick="closeEntryModal()" 
                            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            refreshSignals();
            loadLeaderboard();
            loadTrades();
            setInterval(refreshSignals, 10000);
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('button[id$="Tab"]').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-700');
            });
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.remove('bg-gray-700');
            document.getElementById(tabName + 'Tab').classList.add('bg-blue-600');
        }

        async function refreshSignals() {
            try {
                const response = await fetch('/api/signals');
                const signals = await response.json();
                displaySignals(signals);
            } catch (error) {
                console.error('Error loading signals:', error);
            }
        }

        function displaySignals(signals) {
            const signalsList = document.getElementById('signalsList');
            
            if (signals.length === 0) {
                signalsList.innerHTML = '<div class="text-center py-8 text-gray-400"><p>No signals received yet</p></div>';
                return;
            }

            signalsList.innerHTML = signals.map(signal => {
                const isNew = !signal.analyzed;
                const timeAgo = getTimeAgo(new Date(signal.received_at));

                return `
                    <div class="signal-card bg-gray-800 p-4 rounded-lg border-l-4 ${isNew ? 'border-green-500' : 'border-gray-600'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg font-semibold">${signal.ticker}</span>
                                    <span class="px-2 py-1 rounded text-sm ${signal.action === 'buy' ? 'bg-green-600' : 'bg-red-600'}">
                                        ${signal.action.toUpperCase()}
                                    </span>
                                    ${isNew ? '<span class="px-2 py-1 bg-yellow-600 rounded text-xs">NEW</span>' : ''}
                                </div>
                                <div class="text-gray-400 text-sm mt-1">Price: ${signal.price} | ${timeAgo}</div>
                            </div>
                            <div class="flex space-x-2">
                                ${!signal.analyzed ? `
                                    <button onclick="openTradingView('${signal.ticker}')" 
                                            class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-700 text-sm">
                                        Analyze
                                    </button>
                                    <button onclick="createEntry('${signal.id}', '${signal.ticker}', ${signal.price})" 
                                            class="px-3 py-1 bg-green-600 rounded hover:bg-green-700 text-sm">
                                        Entry
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openTradingView(ticker) {
            const cleanTicker = ticker.replace(/[^A-Z]/g, '');
            const webUrl = `https://www.tradingview.com/chart/?symbol=FX_IDC:${cleanTicker}`;
            window.open(webUrl, '_blank');
        }

        function createEntry(signalId, ticker, price) {
            document.getElementById('entrySignalId').value = signalId;
            document.getElementById('entryPair').value = ticker;
            document.getElementById('entryEntryPrice').value = price;
            document.getElementById('entryModal').classList.remove('hidden');
            document.getElementById('entryModal').classList.add('flex');
        }

        function closeEntryModal() {
            document.getElementById('entryModal').classList.add('hidden');
            document.getElementById('entryModal').classList.remove('flex');
        }

        document.getElementById('entryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                signal_id: document.getElementById('entrySignalId').value,
                pair: document.getElementById('entryPair').value,
                direction: document.getElementById('entryDirection').value,
                entry_price: document.getElementById('entryEntryPrice').value,
                reasoning: document.getElementById('entryReasoning').value,
                created_by: document.getElementById('userName').value || 'Anonymous'
            };

            try {
                await fetch('/api/trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                closeEntryModal();
                loadTrades();
                alert('Trade entry saved!');
            } catch (error) {
                console.error('Error saving trade:', error);
            }
        });

        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const leaderboard = await response.json();
                
                const leaderboardList = document.getElementById('leaderboardList');
                if (leaderboard.length === 0) {
                    leaderboardList.innerHTML = '<p class="text-gray-400">No analysis data yet</p>';
                    return;
                }

                leaderboardList.innerHTML = `
                    <div class="bg-gray-800 rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left">Rank</th>
                                    <th class="px-4 py-3 text-left">Trader</th>
                                    <th class="px-4 py-3 text-right">Avg Response</th>
                                    <th class="px-4 py-3 text-right">Signals</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderboard.map((user, index) => `
                                    <tr class="border-t border-gray-600">
                                        <td class="px-4 py-3">${index + 1}</td>
                                        <td class="px-4 py-3 font-medium">${user.user}</td>
                                        <td class="px-4 py-3 text-right">${user.average_response_time.toFixed(1)}s</td>
                                        <td class="px-4 py-3 text-right">${user.total_signals}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        async function loadTrades() {
            try {
                const response = await fetch('/api/trades');
                const trades = await response.json();
                
                const tradesList = document.getElementById('tradesList');
                if (trades.length === 0) {
                    tradesList.innerHTML = '<p class="text-gray-400">No trades recorded yet</p>';
                    return;
                }

                tradesList.innerHTML = trades.map(trade => `
                    <div class="bg-gray-800 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg font-semibold">${trade.pair}</span>
                                    <span class="px-2 py-1 rounded text-sm ${trade.direction === 'long' ? 'bg-green-600' : 'bg-red-600'}">
                                        ${trade.direction.toUpperCase()}
                                    </span>
                                </div>
                                <div class="text-gray-400 text-sm mt-1">Entry: ${trade.entry_price} | By: ${trade.created_by}</div>
                                ${trade.reasoning ? `<div class="text-gray-300 text-sm mt-2">${trade.reasoning}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        async function testWebhook() {
            try {
                await fetch('/test-webhook', { method: 'POST' });
                setTimeout(refreshSignals, 1000);
            } catch (error) {
                console.error('Error testing webhook:', error);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
    </script>
</body>
</html>
